generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователь
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  telegramId   String?  @unique
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Отношения
  companyMemberships CompanyMember[]
  collectedSamples   Sample[]        @relation("CollectedBy")
  createdProjects    Project[]       @relation("CreatedBy")
  uploadedPhotos     Photo[]         @relation("UploadedPhotos")

  @@map("users")
}

// Компания
model Company {
  id        String   @id @default(cuid())
  name      String
  inn       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Отношения
  members     CompanyMember[]
  invitations Invitation[]
  projects    Project[]

  @@map("companies")
}

// Членство в компании (связь пользователь-компания)
model CompanyMember {
  id        String      @id @default(cuid())
  userId    String
  companyId String
  role      CompanyRole @default(WORKER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Отношения
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

enum CompanyRole {
  OWNER
  ADMIN
  MANAGER
  WORKER
}

// Приглашение в компанию
model Invitation {
  id         String    @id @default(cuid())
  email      String
  role       CompanyRole @default(WORKER)
  companyId  String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  // Отношения
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("invitations")
}

// Проект/Объект
model Project {
  id               String        @id @default(cuid())
  companyId        String
  name             String        // Название проекта
  
  // Связь родитель-дочерний (для доотбора)
  parentProjectId  String?       // ID родительского проекта (если это доотбор)
  
  // Файлы
  tzFileName       String?       // Имя файла ТЗ
  tzFileUrl        String?       // Путь к файлу ТЗ
  orderFileName    String?       // Имя файла поручения
  orderFileUrl     String?       // Путь к файлу поручения
  
  // Извлечённые данные (из AI анализа)
  objectName       String?       // Название объекта из документов
  objectAddress    String?       // Адрес объекта
  objectPurpose    String?       // Назначение объекта
  documentNumber   String?       // Полный номер документа (801-110-25)
  clientName       String?       // Название заказчика
  clientAddress    String?       // Адрес заказчика
  
  // Сопоставленные услуги (JSON)
  services         Json?         // [{row, num, category, name, unit, quantity}]
  
  // Данные отбора проб (извлечённые из поручения)
  samplingLayers   Json?         // [{depthFrom, depthTo, label, count}] - слои отбора
  platformCount    Int?          // Количество площадок (ПП/СК)
  microbiologyCount Int?         // Количество микробиологических проб
  
  // Даты для документов (выбираются пользователем)
  ilcRequestDate   DateTime?     // Дата заявки в ИЛЦ
  fmbaRequestDate  DateTime?     // Дата заявки в ФМБА
  samplingDate     DateTime?     // Дата отбора проб
  
  // Метеоусловия на дату отбора (формат: "начало...окончание", 9:00...12:00)
  weatherTemperature   String?   // Температура воздуха, °C (напр. "-0.5...0.5")
  weatherWind          String?   // Ветер: направление и скорость (напр. "СВ, 5.2...С, 6.0")
  weatherPressure      String?   // Атмосферное давление, мм рт.ст. (напр. "753...755")
  weatherHumidity      String?   // Влажность, % (напр. "80...75")
  weatherSnowDepth     String?   // Высота снежного покрова, м (напр. "0...0")
  
  // Сгенерированный файл
  generatedFileName String?
  generatedFileUrl  String?
  generatedAt       DateTime?
  
  status           ProjectStatus @default(DRAFT)
  processedAt      DateTime?     // Когда была выполнена обработка
  createdById      String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Отношения
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  parentProject Project?    @relation("ParentChild", fields: [parentProjectId], references: [id], onDelete: Cascade)
  childProjects Project[]   @relation("ParentChild")
  platforms     Platform[]
  samples       Sample[]
  photos        Photo[]
  programIei    ProgramIei?

  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

// Площадка
model Platform {
  id        String       @id @default(cuid())
  projectId String
  number    Int
  type      PlatformType
  label     String       // ПП1, СК1 и т.д.
  createdAt DateTime     @default(now())

  // Отношения
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  samples Sample[]

  @@unique([projectId, type, number])
  @@map("platforms")
}

enum PlatformType {
  PP  // Пробная площадка (слой 0,0-0,2)
  SK  // Скважина (остальные слои)
  DO  // Донные отложения
  V   // Вода
}

// Проба
model Sample {
  id             String       @id @default(cuid())
  projectId      String
  platformId     String
  
  // Шифр и нумерация
  cipher         String       // Шифр пробы (напр. 01АХ.01)
  sampleNumber   Int          // Порядковый номер пробы (01, 02...)
  analysisCode   String       // Код анализа (АХ, АМ, АЭ, БХ, ВХ)
  layerNumber    Int          // Номер слоя (.01, .02...)
  
  // Глубина (диапазон)
  depthFrom      Float        // Глубина от (напр. 0.0)
  depthTo        Float        // Глубина до (напр. 0.2)
  depthLabel     String       // Строка глубины (напр. "0,0-0,2")
  
  // Характеристики
  type           SampleType   @default(SOIL)
  description    String?      // Описание/характеристика пробы (заполняет пользователь)
  mass           String       @default("1,0 кг/Пэ") // Масса пробы/тара
  
  // Координаты WGS84
  latitude       String?      // Широта (напр. "55 50.792")
  longitude      String?      // Долгота (напр. "37 39.277")
  gpsPhotoUrl    String?      // Фото GPS трекера
  
  // Статус и служебные поля
  isSubcontract  Boolean      @default(false) // Для микробиологии на подряд
  status         SampleStatus @default(PENDING)
  collectedAt    DateTime?
  collectedById  String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Отношения
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  platform    Platform  @relation(fields: [platformId], references: [id], onDelete: Cascade)
  collectedBy User?     @relation("CollectedBy", fields: [collectedById], references: [id])

  @@unique([projectId, cipher]) // Уникальность cipher в рамках проекта
  @@map("samples")
}

enum SampleType {
  SOIL
  SEDIMENT
  WATER
  AIR
  WASTE
  OTHER
}

// Типовые характеристики проб (справочник для UI)
// глина, суглинок, супесь, песок, торф, ил, гравий, скала, чернозём
// Используется текстовое поле description в Sample

enum SampleStatus {
  PENDING
  COLLECTED
  DELIVERED
  ANALYZED
  COMPLETED
}

// Программа ИЭИ (данные для генерации документа)
model ProgramIei {
  id        String @id @default(cuid())
  projectId String @unique

  // 1.9.4 Обзорная схема размещения объекта
  overviewImageName String?   // Имя файла изображения
  overviewImageUrl  String?   // URL/путь к изображению

  // 1.10 Общие сведения о категориях земель (ЕГРН)
  cadastralNumber   String?   // Кадастровый номер участка
  egrnDescription   String?   // Описание из ЕГРН (категория, разрешённое использование и т.д.)

  // 3.2 Характеристика природных условий (для заполнения вручную в UI)
  coordinatesLat    String?   // Координаты (широта) в десятичном формате, напр. "55.64433"
  coordinatesLon    String?   // Координаты (долгота) в десятичном формате, напр. "37.49028"
  nearbySouth       String?   // "К югу: ..." (только правая часть без префикса)
  nearbyEast        String?   // "К востоку: ..."
  nearbyWest        String?   // "К западу: ..."
  nearbyNorth       String?   // "К северу: ..."

  // 8.2 Обоснование границ изучаемой территории
  section82Text     String?   // Текст пункта 8.2 (редактируемый)

  // Сгенерированный файл
  generatedFileName String?
  generatedFileUrl  String?
  generatedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Отношения
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("program_iei")
}

// Фотография объекта (фотоальбом)
model Photo {
  id           String   @id @default(cuid())
  projectId    String
  
  // Файлы
  filename     String   // UUID + расширение (photo-cuid.jpg)
  originalName String   // Оригинальное имя файла
  thumbnailName String? // Имя превью файла
  
  // Данные
  description  String?  // Описание (вводит пользователь)
  
  // Координаты из EXIF или вручную (десятичный формат)
  latitude     String?  // "55.64433"
  longitude    String?  // "037.49028"
  
  // Дата фото (из EXIF DateTimeOriginal или дата загрузки)
  photoDate    DateTime?
  
  // Порядок в альбоме (для генерации презентации)
  sortOrder    Int      @default(0)
  
  // Служебные
  uploadedAt   DateTime @default(now())
  uploadedById String?

  // Отношения
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy   User?    @relation("UploadedPhotos", fields: [uploadedById], references: [id])

  @@map("photos")
}

